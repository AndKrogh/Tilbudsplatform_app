@page "/project"
@inject IProjectInterface ProjectService
@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<h3>Projekter</h3>

<div>
    <h4>Opret nyt projekt</h4>
    <EditForm Model="newProject" OnValidSubmit="CreateProject">
        <div>
            <label>Projekt Navn:</label>
            <input type="text" @bind="newProject.Name" />
        </div>
        <div>
            <label>Beskrivelse:</label>
            <input type="text" @bind="newProject.Description" />
        </div>
        <div>
            <label>Start Dato:</label>
            <input type="date" @bind="newProject.StartDate" />
        </div>
        <div>
            <label>Slut Dato:</label>
            <input type="date" @bind="newProject.EndDate" />
        </div>
        <div>
            <label>Estimeret Timer:</label>
            <input type="number" @bind="newProject.EstimatedHours" />
        </div>
        <div>
            <label>Timepris:</label>
            <input type="number" @bind="newProject.HourlyRate" />
        </div>
        <div>
            <label>Overskudsgrad:</label>
            <input type="number" @bind="newProject.ProfitMargin" />
        </div>
        <div>
            <label>Kunde ID:</label>
            <input type="number" @bind="newProject.CustomerId" />
        </div>
        <button class="btn btn-primary" type="submit">Opret</button>
    </EditForm>
</div>

<hr />

<div>
    <h4>Projektliste</h4>
    <table class="table">
        <thead>
            <tr>
                <th>Projekt ID</th>
                <th>Navn</th>
                <th>Start Dato</th>
                <th>Slut Dato</th>
                <th>Kunde</th>
                <th>Handlinger</th>
            </tr>
        </thead>
        <tbody>
            @if (projects.Any())
            {
                @foreach (var project in projects)
                {
                    <tr>
                        <td>@project.Id</td>
                        <td>@project.Name</td>
                        <td>@project.StartDate.ToShortDateString()</td>
                        <td>@project.EndDate.ToShortDateString()</td>
                        <td>@project.Customer?.Name</td>
                        <td>
                            <button class="btn btn-danger" @onclick="() => DeleteProject(project.Id)">Slet</button>
                            <button class="btn btn-primary" @onclick="() => NavigateToEstimate(project.Id)">Estimat</button>
                        </td>
                    </tr>
                }
            }
            else
            {
                <tr>
                    <td colspan="6">No projects available.</td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    private Project newProject = new Project
        {
            StartDate = DateTime.Today,
            EndDate = DateTime.Today
        };
    private List<Project> projects = new List<Project>();

    protected override async Task OnInitializedAsync()
    {
        projects = (await ProjectService.GetAllProjectsAsync()).ToList();
    }

    private async Task CreateProject()
    {
        try
        {
            await ProjectService.CreateProjectAsync(newProject);
            projects = (await ProjectService.GetAllProjectsAsync()).ToList();
            newProject = new Project { StartDate = DateTime.Today, EndDate = DateTime.Today };
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private async Task DeleteProject(int id)
    {
        try
        {
            await ProjectService.DeleteProjectAsync(id);
            projects = (await ProjectService.GetAllProjectsAsync()).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
    }

    private void NavigateToEstimate(int projectId)
    {
        NavigationManager.NavigateTo($"/estimate/{projectId}");
    }
}
